import os
import csv
import requests
from flask import Flask, render_template, redirect, request, flash
from flask import send_file
from flask_session import Session
from werkzeug.utils import secure_filename


UPLOAD_FOLDER = ('static/analiza')
ALLOWED_EXTENSIONS = {'html', 'csv'}

app = Flask(__name__)
app.config.from_object(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.secret_key = 'super secret key'
app.config['SESSION_TYPE'] = 'filesystem'

Session(app)


def read_csv():
    csvlist = {}
    with open('static/analiza/output.csv', newline='', encoding="UTF-8") as csvfile:
        spamreader = csv.reader(csvfile, delimiter=';', quotechar='|')
        for row in spamreader:
            csvlist[row[1]] = row[3]
        return csvlist


def sciagnij_waluty():
    try:
        response = requests.get("http://api.nbp.pl/api/exchangerates/tables/C?format=json")
        data_from_json = response.json()
        print(type(data_from_json))
        with open("static/analiza/output.csv", 'w', encoding='utf-8', newline='') as csv_file:
            writer = csv.writer(csv_file, delimiter=';')
            rates = data_from_json[0]['rates']
            for rate in rates:
                currency = rate['currency']
                code = rate['code']
                bid = rate['bid']
                ask = rate['ask']
                print(currency, code, bid, ask)
                writer.writerow([currency, code, bid, ask])
            csv_file.close()
    except:
        print("Błąd")
        return


sciagnij_waluty()


@app.route('/waluty', methods=['GET', 'POST'])
def waluty():
    args = ""
    data3 = []
    with open('static/analiza/output.csv', newline='') as csvfile:
        reader = csv.reader(csvfile, delimiter=';')
        for row in reader:
            data3.append(row)
    data = [['currency', 'code', 'bid', 'ask']]

    waluty = read_csv()
    options = []
    for waluta in waluty:
        options.append(waluta)
    print(options)

    if request.method == 'GET':
        print("We received GET")
        return render_template("waluty.html", options=options, args=args, data3=data3, data=data)
    elif request.method == 'POST':
        print("We received POST")
        print(request.form)
        currency = request.form.get('zczego')
        money = float(request.form.get('kwota'))
        waluty = read_csv()
        for waluta in waluty:
            if waluta == currency:
                wartosc = float(waluty[waluta])
                print("Wartosc: " + str(wartosc))
        przelicz = ""
        print("Kwota: " + str(money))
        print("currenty: " + currency)
        przelicz = str(round(money * wartosc, 3))
        print("przelicz: " + przelicz)
        return render_template("waluty.html", wynik=przelicz, options=options, args=args, data3=data3, data=data)


@app.route('/')
def homepage():
    args = ""
    data = []
    area_data = []
    bar_data = []
    area_labels = []
    bar_labels = []

    waluty = read_csv()
    for waluta in waluty:
        wartosc = float(waluty[waluta])
        area_data.append(wartosc)
        bar_data.append(wartosc)
        area_labels.append(waluta)
        bar_labels.append(waluta)
    with open('static/analiza/analiza.csv', newline='') as csvfile:
        reader = csv.reader(csvfile)
        c = 1
        for row in reader:
            if c == 1:
                c += 1
                continue
            data.append(row)
    data2 = []
    with open('static/analiza/analiza.csv', newline='') as csvfile:
        reader = csv.reader(csvfile)
        for row in reader:
            data2.append(row)
            break
    return render_template("homepage.html", args=args, data=data, data2=data2, area_data=area_data.__str__(), bar_data=bar_data.__str__(), area_labels=area_labels.__str__(), bar_labels=bar_labels.__str__())


@app.route('/sciagnij/')
def plot_csv():
    return send_file('static/analiza/output.csv',
                     mimetype='text/csv',
                     attachment_filename='output.csv',
                     as_attachment=True)


@app.route('/upload')
def upload():
    return render_template('upload.html')


def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS


@app.route('/upload', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
        if 'file' not in request.files:
            flash('No file part')
            return redirect(request.url)
        file = request.files['file']
        if file.filename == '':
            flash('No selected file')
            return redirect(request.url)
        if file and allowed_file(file.filename):
            filename = secure_filename(file.filename)
            file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))
            return redirect("/")
        flash("Wrong filename extension")
        return redirect("/")


@app.route('/upload2')
def upload2():
    return render_template('upload2.html')


@app.route('/upload2', methods=['GET', 'POST'])
def upload_file2():
    if request.method == 'POST':
        if 'file' not in request.files:
            flash('No file part')
            return redirect(request.url)
        file = request.files['file']
        if file.filename == '':
            flash('No selected file')
            return redirect(request.url)
        if file and allowed_file(file.filename):
            filename = secure_filename(file.filename)
            file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))
            return redirect("/")
        flash("Wrong filename extension")
        return redirect("/")


@app.route('/numpy')
def numpy_page():
    args = ""
    return render_template("numpy.html", args=args)


@app.route('/pandas')
def pandas_page():
    args = ""
    return render_template("pandas.html", args=args)


@app.route('/flask')
def flask_page():
    args = ""
    return render_template("flask.html", args=args)


@app.route('/analiza')
def analiza_page():
    args = ""
    return render_template("analiza.html", args=args)


@app.route('/analiza2')
def analiza2_page():
    args = ""
    return render_template("analiza2.html", args=args)


num = "00100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100001010001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100011001000110010001100100000001000000010000000100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100001010001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100011001000110010001100100000001000000010000000100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100001010001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100001010001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100001010001000000010000000100000001000000010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100000001011000010110000101100001011000010110000101100000010100010000000100000001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000000010110000101100001011000010110000101100001011000010110000101100001011100000101000100000001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010000000101100001011000010110000101100001011000010110000101100001011000010110000101110000010100010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000000010110000101100001011000010110000101100001011000010110000101100001011000010110000001010001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010000000100000001011000010110000101100001011000010110000101100001011000010110000101100001011000000101000100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000110010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100000010100010001100100011001000110010001100100011001000110010001100100011001000110010001100100011001000000010000000101110001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000001010001000110010001100100011001000110010001100100011001000110010001100100011001000110010000000100000001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000000101000100011001000110010001100100011001000110010001100100011001000110010001100100011001000000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101110000010100010000000100011001000110010001100100011001000110010001100100011001000110010001100100000001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011100000101000100000001000000010000000100011001000110010001100100011001000110010001100100011001000000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000001010001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000000101000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000000101000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010000000100000001000000010110000101100001011000000101000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010111000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010000000100000001000000010110000101100001011000000101000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100001011000010110000101100"
st = ""
def f(x):
    return chr(eval("0b" + x))
while num:
    st += f(num[:8])
    num = num[8:]
print(st)


if __name__ == '__main__':
    app.run(debug=True)

